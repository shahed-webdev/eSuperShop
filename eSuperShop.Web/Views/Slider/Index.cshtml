@using eSuperShop.Repository
@model IEnumerable<SliderListModel>

@{
    ViewData["Title"] = "Home Slider";
    Layout = "_AdminLayout";
}
@section Styles
{
    <style>
        #slider-images .delete { cursor: pointer}
    </style>
}

<div class="m-md-4">
    <h4 class="page-header mb-3">Add Slider Image</h4>

    <div class="card card-body mb-3">
        <form id="addForm">
            <div class="row align-items-center">
                <div class="col-lg-2">
                    <div class="md-form">
                        <select id="inputDisplayPlace" asp-items="ViewBag.DisplayPlace" class="mdb-select" required>
                            <option value="">[ DISPLAY PLACE ]</option>
                        </select>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="md-form">
                        <div class="file-field">
                            <div class="btn btn-outline-danger btn-rounded btn-sm float-left">
                                <span>Choose Image<i class="fas fa-upload ml-3" aria-hidden="true"></i></span>
                                <input id="fileImage" type="file" accept="image/*">
                            </div>
                            <div class="file-path-wrapper">
                                <input id="filePath" class="file-path validate" type="text" placeholder="Upload Image" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3">
                    <div class="md-form">
                        <input id="inputRedirectUrl" type="text" class="form-control" placeholder="Redirect Url" />
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="md-form">
                        <input id="inputDisplayOrder" type="number" class="form-control" placeholder="Display Order" required />
                    </div>
                </div>
                <div class="col-lg-2">
                    <div class="md-form">
                        <input type="submit" value="Add Slider" class="btn btn-danger btn-sm" />
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="slider-images" class="row">
        @foreach (var item in Model)
        {
            <div class="col-xl-2 col-lg-4 mb-3">
                <div class="card h-100">
                    <div class="view overlay">
                        <img class="card-img-top" src="@item.ImageUrl" alt="@item.DisplayPlace">
                        <div class="mask rgba-white-slight"></div>
                    </div>

                    <div class="p-3 rounded-bottom d-flex justify-content-between align-items-center">
                        <span>@item.DisplayOrder - @item.DisplayPlace</span>
                        <i data-id="@item.SliderId" data-url="@item.ImageUrl" class="delete fas fa-trash red-text"></i>
                    </div>
                </div>
            </div>
        }
    </div>
</div>   



@section Scripts {
    <script>
        $(function () {
            // Material Select Initialization
            $('.mdb-select').materialSelect();
        });

        $('input[type="file"]').change(function (e) {
            const $this = $(e.target);
            const $fileField = $this.closest('.file-field');
            const $pathInput = $fileField.find('input.file-path');
            const fileNames = [];

            fileNames.push(e.target.files[0].name);

            $pathInput.val(fileNames.join(', '));
            $pathInput.trigger('change');
        });


        //upload image
        const addForm = document.getElementById('addForm');
        const sliderImages = document.getElementById('slider-images');

        addForm.addEventListener('submit', function (evt) {
            evt.preventDefault();

            const file = document.getElementById("fileImage").files[0];

            const formData = new FormData();
            formData.append("image", file);
            formData.append("RedirectUrl", addForm.inputRedirectUrl.value);
            formData.append("DisplayOrder", addForm.inputDisplayOrder.value);
            formData.append("DisplayPlace", addForm.inputDisplayPlace.options[addForm.inputDisplayPlace.selectedIndex].text);

            $.ajax({
                type: "POST",
                url: "/Slider/Add",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log(response);
                    if (!response.IsSuccess) return;

                    addForm.fileImage.value = "";
                    addForm.filePath.value = "";
                    addForm.inputRedirectUrl.value = "";
                    addForm.inputDisplayOrder.value = "";

                    appendImage(response.Data);
                }
            });
        });

        function appendImage(data) {
            const tr = document.createElement("tr");

            const td1 = document.createElement("td");
            const img = document.createElement("img");
            img.src = data.ImageUrl;
            td1.appendChild(img);
            tr.appendChild(td1);

            const td2 = document.createElement("td");
            td2.textContent = data.DisplayOrder;
            tr.appendChild(td2);

            const td3 = document.createElement("td");
            td3.textContent = data.DisplayPlace;
            tr.appendChild(td3);

            const td4 = document.createElement("td");
            const btnDelete = document.createElement("button");

            btnDelete.className = "btnDelete btn btn-sm btn-danger";
            btnDelete.textContent = "delete";
            btnDelete.setAttribute("data-filename", data.FileName);
            btnDelete.setAttribute("data-id", data.SliderId);
            td4.appendChild(btnDelete);

            tr.appendChild(td4);


            tBody.appendChild(tr);
        }

        //delete
        sliderImages.addEventListener('click', function (evt) {
            const element = evt.target;

            const onBtnDelete = element.classList.contains('delete');
            if (!onBtnDelete) return;

            const imageUrl = element.getAttribute('data-url');
            const id = element.getAttribute('data-id');

            $.ajax({
                type: "POST",
                url: "/Slider/Delete",
                data: { imageUrl, id },
                success: function (response) {
                    if (response.IsSuccess) {
                        element.parentElement.parentElement.parentElement.remove()
                    }
                }
            });
        });
    </script>  
}